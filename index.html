<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amharic Online Keyboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Ethiopic&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
            padding: 20px; /* Added padding for smaller screens */
            box-sizing: border-box; /* Include padding in element's total width and height */
        }
        .container {
            text-align: center;
            padding: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 100%; /* Use full width up to max-width */
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.8em; /* Responsive font size */
        }
        textarea {
            width: 100%; /* Make textarea responsive */
            /* Removed max-width to allow full container width */
            box-sizing: border-box; /* Include padding and border in width */
            padding: 10px;
            font-size: 18px;
            font-family: 'Noto Sans Ethiopic', 'Nyala', Arial, sans-serif;
            border: 2px solid #ccc;
            border-radius: 5px;
            resize: vertical;
            min-height: 150px;
            margin-bottom: 20px; /* Add space below textarea */
        }
        textarea:focus {
            border-color: #007bff;
            outline: none;
        }
        p {
            color: #555;
            margin-top: 10px;
            line-height: 1.6; /* Improve readability */
        }
        .keyboard {
            display: flex; /* Use flexbox for better alignment */
            flex-direction: column; /* Stack rows vertically */
            gap: 8px; /* Increased gap */
            margin-top: 20px;
            align-items: center; /* Center rows */
            width: 100%; /* Ensure keyboard takes full width */
            overflow-x: auto; /* Allow horizontal scrolling if needed */
            padding-bottom: 10px; /* Add padding at the bottom */
        }
        .keyboard-row {
            display: flex;
            justify-content: center;
            gap: 8px; /* Increased gap */
            width: 100%; /* Ensure rows take full width */
            flex-wrap: wrap; /* Allow keys to wrap on smaller screens */
        }
        .keyboard-key {
            min-width: 45px; /* Slightly larger keys */
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Noto Sans Ethiopic', sans-serif;
            font-size: 18px; /* Larger font size */
            transition: all 0.1s ease-in-out;
            user-select: none; /* Prevent text selection on keys */
            flex: 1 1 auto; /* Allow keys to grow and shrink */
            max-width: 60px; /* Limit max width */
        }
        .keyboard-key:hover {
            background-color: #e9ecef;
            border-color: #bbb;
        }
        .keyboard-key:active {
            background-color: #dee2e6;
            transform: scale(0.96);
        }
        .keyboard-key.space {
            min-width: 200px; /* Adjust width */
            flex-grow: 5; /* Allow spacebar to take more space */
            max-width: 300px;
        }
        .keyboard-key.backspace {
            min-width: 80px; /* Adjust width */
            flex-grow: 2;
            max-width: 100px;
        }
        .keyboard-key.enter { /* Added Enter key style */
            min-width: 80px;
            flex-grow: 2;
            max-width: 100px;
        }
        .instructions {
            margin-top: 30px; /* Increased margin */
            text-align: left;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #eee; /* Subtle border */
        }
        .instructions h3 {
            margin-top: 0;
            color: #0056b3;
        }
        .instructions ul {
            padding-left: 20px;
        }
        .instructions li {
            margin-bottom: 5px;
        }

        /* Media query for smaller screens */
        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            h1 {
                font-size: 1.5em;
            }
            .keyboard-key {
                min-width: 35px;
                height: 35px;
                font-size: 16px;
            }
            .keyboard-key.space {
                min-width: 150px;
            }
            .keyboard-key.backspace, .keyboard-key.enter {
                min-width: 60px;
            }
            .keyboard {
                gap: 5px;
            }
             .keyboard-row {
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Amharic Online Keyboard</h1>
        <textarea id="inputText" placeholder="Start typing here or click the Amharic characters below..." rows="6"></textarea>

        <div class="keyboard">
            <!-- Row 1 -->
            <div class="keyboard-row">
                <div class="keyboard-key" data-char="ሀ">ሀ</div> <div class="keyboard-key" data-char="ሁ">ሁ</div> <div class="keyboard-key" data-char="ሂ">ሂ</div> <div class="keyboard-key" data-char="ሃ">ሃ</div> <div class="keyboard-key" data-char="ሄ">ሄ</div> <div class="keyboard-key" data-char="ህ">ህ</div> <div class="keyboard-key" data-char="ሆ">ሆ</div>
                <div class="keyboard-key" data-char="ለ">ለ</div> <div class="keyboard-key" data-char="ሉ">ሉ</div> <div class="keyboard-key" data-char="ሊ">ሊ</div>
            </div>
             <!-- Row 2 -->
            <div class="keyboard-row">
                 <div class="keyboard-key" data-char="ላ">ላ</div> <div class="keyboard-key" data-char="ሌ">ሌ</div> <div class="keyboard-key" data-char="ል">ል</div> <div class="keyboard-key" data-char="ሎ">ሎ</div> <div class="keyboard-key" data-char="ሏ">ሏ</div>
                 <div class="keyboard-key" data-char="መ">መ</div> <div class="keyboard-key" data-char="ሙ">ሙ</div> <div class="keyboard-key" data-char="ሚ">ሚ</div> <div class="keyboard-key" data-char="ማ">ማ</div> <div class="keyboard-key" data-char="ሜ">ሜ</div>
            </div>
            <!-- Row 3 -->
            <div class="keyboard-row">
                <div class="keyboard-key" data-char="ም">ም</div> <div class="keyboard-key" data-char="ሞ">ሞ</div> <div class="keyboard-key" data-char="ሟ">ሟ</div>
                <div class="keyboard-key" data-char="ሰ">ሰ</div> <div class="keyboard-key" data-char="ሱ">ሱ</div> <div class="keyboard-key" data-char="ሲ">ሲ</div> <div class="keyboard-key" data-char="ሳ">ሳ</div> <div class="keyboard-key" data-char="ሴ">ሴ</div> <div class="keyboard-key" data-char="ስ">ስ</div> <div class="keyboard-key" data-char="ሶ">ሶ</div>
            </div>
            <!-- Row 4 -->
             <div class="keyboard-row">
                <div class="keyboard-key" data-char="ሷ">ሷ</div>
                <div class="keyboard-key" data-char="ረ">ረ</div> <div class="keyboard-key" data-char="ሩ">ሩ</div> <div class="keyboard-key" data-char="ሪ">ሪ</div> <div class="keyboard-key" data-char="ራ">ራ</div> <div class="keyboard-key" data-char="ሬ">ሬ</div> <div class="keyboard-key" data-char="ር">ር</div> <div class="keyboard-key" data-char="ሮ">ሮ</div> <div class="keyboard-key" data-char="ሯ">ሯ</div>
                <div class="keyboard-key" data-char="ሸ">ሸ</div>
            </div>
             <!-- Row 5 -->
            <div class="keyboard-row">
                 <div class="keyboard-key" data-char="ሹ">ሹ</div> <div class="keyboard-key" data-char="ሺ">ሺ</div> <div class="keyboard-key" data-char="ሻ">ሻ</div> <div class="keyboard-key" data-char="ሼ">ሼ</div> <div class="keyboard-key" data-char="ሽ">ሽ</div> <div class="keyboard-key" data-char="ሾ">ሾ</div> <div class="keyboard-key" data-char="ሿ">ሿ</div>
                 <div class="keyboard-key" data-char="ቀ">ቀ</div> <div class="keyboard-key" data-char="ቁ">ቁ</div> <div class="keyboard-key" data-char="ቂ">ቂ</div>
            </div>
            <!-- Row 6 -->
            <div class="keyboard-row">
                 <div class="keyboard-key" data-char="ቃ">ቃ</div> <div class="keyboard-key" data-char="ቄ">ቄ</div> <div class="keyboard-key" data-char="ቅ">ቅ</div> <div class="keyboard-key" data-char="ቆ">ቆ</div> <div class="keyboard-key" data-char="ቋ">ቋ</div>
                 <div class="keyboard-key" data-char="በ">በ</div> <div class="keyboard-key" data-char="ቡ">ቡ</div> <div class="keyboard-key" data-char="ቢ">ቢ</div> <div class="keyboard-key" data-char="ባ">ባ</div> <div class="keyboard-key" data-char="ቤ">ቤ</div>
            </div>
            <!-- Row 7 -->
            <div class="keyboard-row">
                 <div class="keyboard-key" data-char="ብ">ብ</div> <div class="keyboard-key" data-char="ቦ">ቦ</div> <div class="keyboard-key" data-char="ቧ">ቧ</div>
                 <div class="keyboard-key" data-char="ተ">ተ</div> <div class="keyboard-key" data-char="ቱ">ቱ</div> <div class="keyboard-key" data-char="ቲ">ቲ</div> <div class="keyboard-key" data-char="ታ">ታ</div> <div class="keyboard-key" data-char="ቴ">ቴ</div> <div class="keyboard-key" data-char="ት">ት</div> <div class="keyboard-key" data-char="ቶ">ቶ</div>
            </div>
            <!-- Row 8 -->
            <div class="keyboard-row">
                 <div class="keyboard-key" data-char="ቷ">ቷ</div>
                 <div class="keyboard-key" data-char="ቸ">ቸ</div> <div class="keyboard-key" data-char="ቹ">ቹ</div> <div class="keyboard-key" data-char="ቺ">ቺ</div> <div class="keyboard-key" data-char="ቻ">ቻ</div> <div class="keyboard-key" data-char="ቼ">ቼ</div> <div class="keyboard-key" data-char="ች">ች</div> <div class="keyboard-key" data-char="ቾ">ቾ</div> <div class="keyboard-key" data-char="ቿ">ቿ</div>
                 <div class="keyboard-key" data-char="ነ">ነ</div>
            </div>
            <!-- Row 9 -->
            <div class="keyboard-row">
                 <div class="keyboard-key" data-char="ኑ">ኑ</div> <div class="keyboard-key" data-char="ኒ">ኒ</div> <div class="keyboard-key" data-char="ና">ና</div> <div class="keyboard-key" data-char="ኔ">ኔ</div> <div class="keyboard-key" data-char="ን">ን</div> <div class="keyboard-key" data-char="ኖ">ኖ</div> <div class="keyboard-key" data-char="ኗ">ኗ</div>
                 <div class="keyboard-key" data-char="ኘ">ኘ</div> <div class="keyboard-key" data-char="ኙ">ኙ</div> <div class="keyboard-key" data-char="ኚ">ኚ</div>
            </div>
            <!-- Row 10 -->
            <div class="keyboard-row">
                 <div class="keyboard-key" data-char="ኛ">ኛ</div> <div class="keyboard-key" data-char="ኜ">ኜ</div> <div class="keyboard-key" data-char="ኝ">ኝ</div> <div class="keyboard-key" data-char="ኞ">ኞ</div> <div class="keyboard-key" data-char="ኟ">ኟ</div>
                 <div class="keyboard-key" data-char="አ">አ</div> <div class="keyboard-key" data-char="ኡ">ኡ</div> <div class="keyboard-key" data-char="ኢ">ኢ</div> <div class="keyboard-key" data-char="ኣ">ኣ</div> <div class="keyboard-key" data-char="ኤ">ኤ</div>
            </div>
            <!-- Row 11 -->
            <div class="keyboard-row">
                 <div class="keyboard-key" data-char="እ">እ</div> <div class="keyboard-key" data-char="ኦ">ኦ</div> <div class="keyboard-key" data-char="ኧ">ኧ</div>
                 <div class="keyboard-key" data-char="ከ">ከ</div> <div class="keyboard-key" data-char="ኩ">ኩ</div> <div class="keyboard-key" data-char="ኪ">ኪ</div> <div class="keyboard-key" data-char="ካ">ካ</div> <div class="keyboard-key" data-char="ኬ">ኬ</div> <div class="keyboard-key" data-char="ክ">ክ</div> <div class="keyboard-key" data-char="ኮ">ኮ</div>
            </div>
            <!-- Row 12 -->
            <div class="keyboard-row">
                 <div class="keyboard-key" data-char="ኳ">ኳ</div>
                 <div class="keyboard-key" data-char="ወ">ወ</div> <div class="keyboard-key" data-char="ዉ">ዉ</div> <div class="keyboard-key" data-char="ዊ">ዊ</div> <div class="keyboard-key" data-char="ዋ">ዋ</div> <div class="keyboard-key" data-char="ዌ">ዌ</div> <div class="keyboard-key" data-char="ው">ው</div> <div class="keyboard-key" data-char="ዎ">ዎ</div>
                 <div class="keyboard-key" data-char="ዘ">ዘ</div> <div class="keyboard-key" data-char="ዙ">ዙ</div>
            </div>
             <!-- Row 13 -->
            <div class="keyboard-row">
                 <div class="keyboard-key" data-char="ዚ">ዚ</div> <div class="keyboard-key" data-char="ዛ">ዛ</div> <div class="keyboard-key" data-char="ዜ">ዜ</div> <div class="keyboard-key" data-char="ዝ">ዝ</div> <div class="keyboard-key" data-char="ዞ">ዞ</div> <div class="keyboard-key" data-char="ዟ">ዟ</div>
                 <div class="keyboard-key" data-char="ዠ">ዠ</div> <div class="keyboard-key" data-char="ዡ">ዡ</div> <div class="keyboard-key" data-char="ዢ">ዢ</div> <div class="keyboard-key" data-char="ዣ">ዣ</div>
            </div>
             <!-- Row 14 -->
            <div class="keyboard-row">
                 <div class="keyboard-key" data-char="ዤ">ዤ</div> <div class="keyboard-key" data-char="ዥ">ዥ</div> <div class="keyboard-key" data-char="ዦ">ዦ</div> <div class="keyboard-key" data-char="ዧ">ዧ</div>
                 <div class="keyboard-key" data-char="የ">የ</div> <div class="keyboard-key" data-char="ዩ">ዩ</div> <div class="keyboard-key" data-char="ዪ">ዪ</div> <div class="keyboard-key" data-char="ያ">ያ</div> <div class="keyboard-key" data-char="ዬ">ዬ</div> <div class="keyboard-key" data-char="ይ">ይ</div>
            </div>
             <!-- Row 15 -->
            <div class="keyboard-row">
                 <div class="keyboard-key" data-char="ዮ">ዮ</div>
                 <div class="keyboard-key" data-char="ደ">ደ</div> <div class="keyboard-key" data-char="ዱ">ዱ</div> <div class="keyboard-key" data-char="ዲ">ዲ</div> <div class="keyboard-key" data-char="ዳ">ዳ</div> <div class="keyboard-key" data-char="ዴ">ዴ</div> <div class="keyboard-key" data-char="ድ">ድ</div> <div class="keyboard-key" data-char="ዶ">ዶ</div> <div class="keyboard-key" data-char="ዷ">ዷ</div>
                 <div class="keyboard-key" data-char="ጀ">ጀ</div>
            </div>
             <!-- Row 16 -->
            <div class="keyboard-row">
                 <div class="keyboard-key" data-char="ጁ">ጁ</div> <div class="keyboard-key" data-char="ጂ">ጂ</div> <div class="keyboard-key" data-char="ጃ">ጃ</div> <div class="keyboard-key" data-char="ጄ">ጄ</div> <div class="keyboard-key" data-char="ጅ">ጅ</div> <div class="keyboard-key" data-char="ጆ">ጆ</div> <div class="keyboard-key" data-char="ጇ">ጇ</div>
                 <div class="keyboard-key" data-char="ገ">ገ</div> <div class="keyboard-key" data-char="ጉ">ጉ</div> <div class="keyboard-key" data-char="ጊ">ጊ</div>
            </div>
             <!-- Row 17 -->
            <div class="keyboard-row">
                 <div class="keyboard-key" data-char="ጋ">ጋ</div> <div class="keyboard-key" data-char="ጌ">ጌ</div> <div class="keyboard-key" data-char="ግ">ግ</div> <div class="keyboard-key" data-char="ጎ">ጎ</div> <div class="keyboard-key" data-char="ጓ">ጓ</div>
                 <div class="keyboard-key" data-char="ጠ">ጠ</div> <div class="keyboard-key" data-char="ጡ">ጡ</div> <div class="keyboard-key" data-char="ጢ">ጢ</div> <div class="keyboard-key" data-char="ጣ">ጣ</div> <div class="keyboard-key" data-char="ጤ">ጤ</div>
            </div>
             <!-- Row 18 -->
            <div class="keyboard-row">
                 <div class="keyboard-key" data-char="ጥ">ጥ</div> <div class="keyboard-key" data-char="ጦ">ጦ</div> <div class="keyboard-key" data-char="ጧ">ጧ</div>
                 <div class="keyboard-key" data-char="ጨ">ጨ</div> <div class="keyboard-key" data-char="ጩ">ጩ</div> <div class="keyboard-key" data-char="ጪ">ጪ</div> <div class="keyboard-key" data-char="ጫ">ጫ</div> <div class="keyboard-key" data-char="ጬ">ጬ</div> <div class="keyboard-key" data-char="ጭ">ጭ</div> <div class="keyboard-key" data-char="ጮ">ጮ</div>
            </div>
             <!-- Row 19 -->
            <div class="keyboard-row">
                 <div class="keyboard-key" data-char="ጯ">ጯ</div>
                 <div class="keyboard-key" data-char="ጰ">ጰ</div> <div class="keyboard-key" data-char="ጱ">ጱ</div> <div class="keyboard-key" data-char="ጲ">ጲ</div> <div class="keyboard-key" data-char="ጳ">ጳ</div> <div class="keyboard-key" data-char="ጴ">ጴ</div> <div class="keyboard-key" data-char="ጵ">ጵ</div> <div class="keyboard-key" data-char="ጶ">ጶ</div> <div class="keyboard-key" data-char="ጷ">ጷ</div>
                 <div class="keyboard-key" data-char="ፀ">ፀ</div>
            </div>
             <!-- Row 20 -->
            <div class="keyboard-row">
                 <div class="keyboard-key" data-char="ፁ">ፁ</div> <div class="keyboard-key" data-char="ፂ">ፂ</div> <div class="keyboard-key" data-char="ፃ">ፃ</div> <div class="keyboard-key" data-char="ፄ">ፄ</div> <div class="keyboard-key" data-char="ፅ">ፅ</div> <div class="keyboard-key" data-char="ፆ">ፆ</div> <div class="keyboard-key" data-char="ፇ">ፇ</div>
                 <div class="keyboard-key" data-char="ፈ">ፈ</div> <div class="keyboard-key" data-char="ፉ">ፉ</div> <div class="keyboard-key" data-char="ፊ">ፊ</div>
            </div>
             <!-- Row 21 -->
            <div class="keyboard-row">
                 <div class="keyboard-key" data-char="ፋ">ፋ</div> <div class="keyboard-key" data-char="ፌ">ፌ</div> <div class="keyboard-key" data-char="ፍ">ፍ</div> <div class="keyboard-key" data-char="ፎ">ፎ</div> <div class="keyboard-key" data-char="ፏ">ፏ</div>
                 <div class="keyboard-key" data-char="ፐ">ፐ</div> <div class="keyboard-key" data-char="ፑ">ፑ</div> <div class="keyboard-key" data-char="ፒ">ፒ</div> <div class="keyboard-key" data-char="ፓ">ፓ</div> <div class="keyboard-key" data-char="ፔ">ፔ</div>
            </div>
             <!-- Row 22 -->
            <div class="keyboard-row">
                 <div class="keyboard-key" data-char="ፕ">ፕ</div> <div class="keyboard-key" data-char="ፖ">ፖ</div> <div class="keyboard-key" data-char="ፗ">ፗ</div>
                 <!-- Special Characters -->
                 <div class="keyboard-key" data-char="፡">፡</div> <div class="keyboard-key" data-char="።">።</div> <div class="keyboard-key" data-char="፣">፣</div> <div class="keyboard-key" data-char="፤">፤</div> <div class="keyboard-key" data-char="፥">፥</div> <div class="keyboard-key" data-char="፦">፦</div> <div class="keyboard-key" data-char="፧">፧</div>
            </div>
             <!-- Row 23: Numbers -->
            <div class="keyboard-row">
                 <div class="keyboard-key" data-char="፩">፩</div> <div class="keyboard-key" data-char="፪">፪</div> <div class="keyboard-key" data-char="፫">፫</div> <div class="keyboard-key" data-char="፬">፬</div> <div class="keyboard-key" data-char="፭">፭</div> <div class="keyboard-key" data-char="፮">፮</div> <div class="keyboard-key" data-char="፯">፯</div> <div class="keyboard-key" data-char="፰">፰</div> <div class="keyboard-key" data-char="፱">፱</div> <div class="keyboard-key" data-char="፲">፲</div>
            </div>
             <!-- Row 24: Control Keys -->
            <div class="keyboard-row">
                <div class="keyboard-key space" data-char=" ">Space</div>
                <div class="keyboard-key backspace" data-action="backspace">⌫ Backspace</div>
                <div class="keyboard-key enter" data-action="enter">Enter</div>
            </div>
        </div>

        <div class="instructions">
            <h3>Instructions:</h3>
            <p><strong>Typing Method:</strong> Type phonetic equivalents (Latin letters) and they will automatically convert to Amharic characters as you type. Pressing space, punctuation, or enter finalizes the current character.</p>
            <p><strong>Examples:</strong></p>
            <ul>
                <li>s + e = ሰ</li>
                <li>s + u = ሱ</li>
                <li>s + i = ሲ</li>
                <li>s + a = ሳ</li>
                <li>s + ee = ሴ (or s + e + e)</li>
                <li>s + e (then space/punctuation) = ስ</li>
                <li>s + o = ሶ</li>
                <li>sh + a = ሻ</li>
                <li>t + t + a = ጣ</li>
            </ul>
            <p><strong>Special Cases:</strong></p>
             <ul>
                <li>For the 6th form (e.g., ስ, ል, ም), type the consonant sound (e.g., 's', 'l', 'm', 'sh') and then press space or punctuation.</li>
                <li>Some sounds require multiple letters (e.g., 'sh', 'ch', 'ny', 'zh', 'ts', 'gn', 'tt', 'pp'). Use 'pp' for ጰ/ጳ sounds and 'p' for ፐ/ፓ sounds.</li>
                <li>Use an apostrophe (') before standalone vowels: 'a -> አ, 'u -> ኡ, 'i -> ኢ, 'aa -> ኣ, 'ee -> ኤ, 'e -> እ, 'o -> ኦ.</li>
            </ul>
            <p>You can also click on the Amharic characters or keys above to insert them directly.</p>
        </div>
    </div>

    <script>
        const inputText = document.getElementById('inputText');
        const keyboardContainer = document.querySelector('.keyboard');
        let currentBuffer = ''; // Stores the sequence of typed Latin letters
        let lastConversionLength = 0; // Track length of last Latin sequence converted

        // --- Phonetic Mapping ---
        const amharicMap = {
            // Consonant + Vowel combinations (Sorted by Latin length desc)
            'hhwa': 'ሗ', 'hhua': 'ሗ',
            'shwa': 'ሿ', 'shua': 'ሿ',
            'chwa': 'ቿ', 'chua': 'ቿ',
            'nywa': 'ኟ', 'nyua': 'ኟ',
            'zhwa': 'ዧ', 'zhua': 'ዧ',
            'cchwa': 'ጯ', 'cchua': 'ጯ',
            'gnwa': 'ጟ', 'gnua': 'ጟ',
            'hho': 'ሖ', // Using one mapping for simplicity, can be adjusted
            'hhe': 'ሕ',
            'hhee': 'ሔ',
            'hhaa': 'ሓ',
            'hhi': 'ሒ',
            'hhu': 'ሑ',
            'ssa': 'ሣ', 'ssu': 'ሡ', 'ssi': 'ሢ', 'ssee': 'ሤ', 'sse': 'ሥ', 'sso': 'ሦ', 'sswa': 'ሧ', 'ssua': 'ሧ',
            'kxa': 'ኸ', 'kxu': 'ኹ', 'kxi': 'ኺ', 'kxaa': 'ኻ', 'kxee': 'ኼ', 'kxe': 'ኽ', 'kxo': 'ኾ', 'kxwa': 'ዃ', 'kxua': 'ዃ',
            'tta': 'ጠ', 'ttu': 'ጡ', 'tti': 'ጢ', 'ttaa': 'ጣ', 'ttee': 'ጤ', 'tte': 'ጥ', 'tto': 'ጦ', 'ttwa': 'ጧ', 'ttua': 'ጧ',
            'ccha': 'ጨ', 'cchu': 'ጩ', 'cchi': 'ጪ', 'cchaa': 'ጫ', 'cchee': 'ጬ', 'cche': 'ጭ', 'ccho': 'ጮ', // 'cchwa' handled above
            'tsa': 'ፀ', 'tsu': 'ፁ', 'tsi': 'ፂ', 'tsaa': 'ፃ', 'tsee': 'ፄ', 'tse': 'ፅ', 'tso': 'ፆ', 'tswa': 'ፇ', 'tsua': 'ፇ',
            'gna': 'ኛ', 'gnu': 'ኙ', 'gni': 'ኚ', 'gnaa': 'ኛ', 'gnee': 'ኜ', 'gne': 'ኝ', 'gno': 'ኞ', // 'gnwa' handled above
            'nya': 'ኘ', 'nyu': 'ኙ', 'nyi': 'ኚ', 'nyaa': 'ኛ', 'nyee': 'ኜ', 'nye': 'ኝ', 'nyo': 'ኞ', // 'nywa' handled above
            'sha': 'ሸ', 'shu': 'ሹ', 'shi': 'ሺ', 'shaa': 'ሻ', 'shee': 'ሼ', 'she': 'ሽ', 'sho': 'ሾ', // 'shwa' handled above
            'cha': 'ቸ', 'chu': 'ቹ', 'chi': 'ቺ', 'chaa': 'ቻ', 'chee': 'ቼ', 'che': 'ች', 'cho': 'ቾ', // 'chwa' handled above
            'zha': 'ዠ', 'zhu': 'ዡ', 'zhi': 'ዢ', 'zhaa': 'ዣ', 'zhee': 'ዤ', 'zhe': 'ዥ', 'zho': 'ዦ', // 'zhwa' handled above
            'qwa': 'ቋ', 'qua': 'ቋ', 'qoa': 'ቈ',
            'bwa': 'ቧ', 'bua': 'ቧ',
            'twa': 'ቷ', 'tua': 'ቷ',
            'nwa': 'ኗ', 'nua': 'ኗ',
            'kwa': 'ኳ', 'kua': 'ኳ',
            'zwa': 'ዟ', 'zua': 'ዟ',
            'dwa': 'ዷ', 'dua': 'ዷ',
            'jwa': 'ጇ', 'jua': 'ጇ',
            'gwa': 'ጓ', 'gua': 'ጓ',
            'pwa': 'ጷ', 'pua': 'ጷ', // For ጰ series - Use 'pp' instead below
            'fwa': 'ፏ', 'fua': 'ፏ',
            'ppwa': 'ፗ', 'ppua': 'ፗ', // Use 'pp' for ፐ series 'pwa'

            // Standard Consonant + Vowel
            'ha': 'ሀ', 'hu': 'ሁ', 'hi': 'ሂ', 'haa': 'ሃ', 'hee': 'ሄ', 'he': 'ህ', 'ho': 'ሆ',
            'le': 'ለ', 'lu': 'ሉ', 'li': 'ሊ', 'laa': 'ላ', 'lee': 'ሌ', 'l': 'ል', 'lo': 'ሎ', 'lua': 'ሏ',
            'me': 'መ', 'mu': 'ሙ', 'mi': 'ሚ', 'ma': 'ማ', 'maa': 'ማ', 'mee': 'ሜ', 'm': 'ም', 'mo': 'ሞ', 'mua': 'ሟ',
            're': 'ረ', 'ru': 'ሩ', 'ri': 'ሪ', 'raa': 'ራ', 'ree': 'ሬ', 'r': 'ር', 'ro': 'ሮ', 'rwa': 'ሯ', 'rua': 'ሯ',
            'se': 'ሰ', 'su': 'ሱ', 'si': 'ሲ', 'saa': 'ሳ', 'see': 'ሴ', 's': 'ስ', 'so': 'ሶ', 'swa': 'ሷ', 'sua': 'ሷ',
            'qe': 'ቀ', 'qu': 'ቁ', 'qi': 'ቂ', 'qaa': 'ቃ', 'qee': 'ቄ', 'q': 'ቅ', 'qo': 'ቆ',
            'be': 'በ', 'bu': 'ቡ', 'bi': 'ቢ', 'baa': 'ባ', 'bee': 'ቤ', 'b': 'ብ', 'bo': 'ቦ',
            'te': 'ተ', 'tu': 'ቱ', 'ti': 'ቲ', 'taa': 'ታ', 'tee': 'ቴ', 't': 'ት', 'to': 'ቶ',
            'ne': 'ነ', 'nu': 'ኑ', 'ni': 'ኒ', 'naa': 'ና', 'nee': 'ኔ', 'n': 'ን', 'no': 'ኖ',
            'ka': 'ከ', 'ku': 'ኩ', 'ki': 'ኪ', 'kaa': 'ካ', 'kee': 'ኬ', 'k': 'ክ', 'ko': 'ኮ',
            'we': 'ወ', 'wu': 'ዉ', 'wi': 'ዊ', 'waa': 'ዋ', 'wee': 'ዌ', 'w': 'ው', 'wo': 'ዎ',
            'ze': 'ዘ', 'zu': 'ዙ', 'zi': 'ዚ', 'zaa': 'ዛ', 'zee': 'ዜ', 'z': 'ዝ', 'zo': 'ዞ',
            'ye': 'የ', 'yu': 'ዩ', 'yi': 'ዪ', 'yaa': 'ያ', 'yee': 'ዬ', 'y': 'ይ', 'yo': 'ዮ',
            'de': 'ደ', 'du': 'ዱ', 'di': 'ዲ', 'daa': 'ዳ', 'dee': 'ዴ', 'd': 'ድ', 'do': 'ዶ',
            'je': 'ጀ', 'ju': 'ጁ', 'ji': 'ጂ', 'jaa': 'ጃ', 'jee': 'ጄ', 'j': 'ጅ', 'jo': 'ጆ',
            'ge': 'ገ', 'gu': 'ጉ', 'gi': 'ጊ', 'gaa': 'ጋ', 'gee': 'ጌ', 'g': 'ግ', 'go': 'ጎ',
            'ppe': 'ጰ', 'ppu': 'ጱ', 'ppi': 'ጲ', 'ppaa': 'ጳ', 'ppee': 'ጴ', 'pp': 'ጵ', 'ppo': 'ጶ', 'ppwa': 'ጷ', // Use 'pp' for ጰ series
            'fe': 'ፈ', 'fu': 'ፉ', 'fi': 'ፊ', 'faa': 'ፋ', 'fee': 'ፌ', 'f': 'ፍ', 'fo': 'ፎ',
            'pe': 'ፐ', 'pu': 'ፑ', 'pi': 'ፒ', 'paa': 'ፓ', 'pee': 'ፔ', 'p': 'ፕ', 'po': 'ፖ', // Use 'p' for ፐ series

             // Standalone Vowels (using apostrophe prefix)
            '\'a': 'አ', '\'u': 'ኡ', '\'i': 'ኢ', '\'aa': 'ኣ', '\'ee': 'ኤ', '\'e': 'እ', '\'o': 'ኦ', '\'ea': 'ኧ',

            // Numbers
            '1': '፩', '2': '፪', '3': '፫', '4': '፬', '5': '፭', '6': '፮', '7': '፯', '8': '፰', '9': '፱', '10': '፲',
            '20': '፳', '30': '፴', '40': '፵', '50': '፶', '60': '፷', '70': '፸', '80': '፹', '90': '፺', '100': '፻'
        };

        // Map base consonant sounds to their 6th form for finalization
        const sixthFormMap = {
             'h': 'ህ', 'l': 'ል', 'hh': 'ሕ', 'm': 'ም', 'ss': 'ሥ', 'r': 'ር', 's': 'ስ',
             'sh': 'ሽ', 'q': 'ቅ', 'b': 'ብ', 't': 'ት', 'ch': 'ች', // 'h': 'ኅ', // Ambiguous 'h' removed, use 'hh' or specific input
             'n': 'ን', 'ny': 'ኝ', 'gn': 'ኝ', // Added gn
             // 'a': 'እ', // Removed 'a' -> 'እ' finalization, use explicit 'e
             'k': 'ክ', 'kx': 'ኽ', 'w': 'ው', '´': 'ዕ', // Using '´' (backtick) for 'ዕ' 6th form
             'z': 'ዝ', 'zh': 'ዥ', 'y': 'ይ', 'd': 'ድ', 'j': 'ጅ', 'g': 'ግ',
             'tt': 'ጥ', 'cch': 'ጭ', 'pp': 'ጵ', 'ts': 'ፅ', 'f': 'ፍ', 'p': 'ፕ',
             // Add single vowels if they should finalize to a specific form on space
             'e': 'እ', // Finalize 'e' to 'እ'
             // 'i': 'ኢ', 'o': 'ኦ', 'u': 'ኡ' // Usually vowels don't finalize to 6th form
        };

        // --- Helper Functions ---

        function insertText(textToInsert, replaceLength = 0) {
            const start = inputText.selectionStart;
            const end = inputText.selectionEnd;
            const text = inputText.value;
            // Calculate position before the characters to be replaced
            const positionBeforeReplacement = start - replaceLength;

            // Ensure position is not negative
            const effectiveStart = Math.max(0, positionBeforeReplacement);

            inputText.value = text.substring(0, effectiveStart) + textToInsert + text.substring(end);
            // Place cursor right after the newly inserted text
            inputText.selectionStart = inputText.selectionEnd = effectiveStart + textToInsert.length;
            inputText.focus();
            // Trigger input event for frameworks or other listeners
            inputText.dispatchEvent(new Event('input', { bubbles: true }));
        }


        function handleBackspace() {
            const start = inputText.selectionStart;
            const end = inputText.selectionEnd;

            if (start === end && start > 0) {
                // Simple backspace: Delete character before cursor
                inputText.value = inputText.value.substring(0, start - 1) + inputText.value.substring(end);
                inputText.selectionStart = inputText.selectionEnd = start - 1;
            } else if (start !== end) {
                // Delete selection
                inputText.value = inputText.value.substring(0, start) + inputText.value.substring(end);
                inputText.selectionStart = inputText.selectionEnd = start;
            }
            // Clear buffer on any backspace for simplicity, prevents complex undo logic
            currentBuffer = '';
            lastConversionLength = 0;
            inputText.focus();
            inputText.dispatchEvent(new Event('input', { bubbles: true }));
        }

        function handleEnter() {
             finalizeBuffer(); // Finalize before newline
             insertText('\n'); // Insert newline at current cursor position
             currentBuffer = ''; // Clear buffer after enter
             lastConversionLength = 0;
        }

        // Tries to convert the current buffer to Amharic
        function processBuffer() {
            if (!currentBuffer) {
                lastConversionLength = 0;
                return false; // Nothing to process
            }

            let bufferProcessed = false; // Flag to check if any part of the buffer was processed in this call
            let originalBuffer = currentBuffer; // Keep original buffer for potential recursion check

            // Check from longest match to shortest
            const sortedKeys = Object.keys(amharicMap).sort((a, b) => b.length - a.length);

            for (const key of sortedKeys) {
                if (currentBuffer.endsWith(key)) {
                    const amharicChar = amharicMap[key];
                    // Replace the matched Latin part (key) with the Amharic char
                    // The 'replaceLength' is the length of the Latin key we just matched
                    insertText(amharicChar, key.length);
                    // Update buffer: remove the matched part from the end
                    currentBuffer = currentBuffer.slice(0, -key.length);
                    lastConversionLength = key.length; // Track length of converted sequence
                    bufferProcessed = true; // Mark that we processed something

                    // If buffer still has content, try processing the remainder recursively
                    if (currentBuffer.length > 0) {
                       // Avoid infinite recursion if no change happens
                       if (currentBuffer !== originalBuffer) {
                           processBuffer(); // Recursive call
                       }
                    }
                    // Once a match is found and processed, exit the loop for this call
                    return true; // Indicate that a conversion happened
                }
            }

            // If loop finishes without finding a match at the end
            lastConversionLength = 0; // No conversion happened in this pass
            return false; // Indicate no conversion happened
        }


        // Finalizes the buffer, typically converting to 6th form if applicable
        function finalizeBuffer() {
            if (!currentBuffer) return; // Nothing to finalize

            let amharicChar = null;
            let keyLength = 0;

            // Check if the entire buffer matches a 6th form key (longest first)
            const sortedSixthKeys = Object.keys(sixthFormMap).sort((a, b) => b.length - a.length);
            for(const key of sortedSixthKeys) {
                if (currentBuffer === key) {
                    amharicChar = sixthFormMap[key];
                    keyLength = key.length;
                    break; // Found the longest matching 6th form key
                }
            }

            if (amharicChar) {
                // Replace the entire buffer with the 6th form character
                insertText(amharicChar, keyLength);
            }
            // If no 6th form match, the buffer remains as typed Latin letters (which are already in the textarea)
            // Clear buffer regardless of whether a 6th form conversion happened
            currentBuffer = '';
            lastConversionLength = 0;
        }


        // --- Event Listeners ---

        keyboardContainer.addEventListener('click', (e) => {
            const target = e.target.closest('.keyboard-key');
            if (!target) return;

            const char = target.getAttribute('data-char');
            const action = target.getAttribute('data-action');

            finalizeBuffer(); // Finalize any pending buffer before button press

            if (char) {
                insertText(char); // Directly insert clicked character
            } else if (action === 'backspace') {
                handleBackspace();
            } else if (action === 'enter') {
                handleEnter();
            }
             // Clear buffer after any virtual key action for clean state
             currentBuffer = '';
             lastConversionLength = 0;
        });

        inputText.addEventListener('keydown', (e) => {
            // Let Backspace and Enter be handled by their dedicated functions
            if (e.key === 'Backspace') {
                handleBackspace();
                e.preventDefault(); // Prevent default backspace since we handle it
                return;
            }
            if (e.key === 'Enter') {
                handleEnter();
                e.preventDefault(); // Prevent default Enter since we handle it
                return;
            }

            // Ignore modifiers, arrows, etc., but finalize buffer first
            if (e.ctrlKey || e.metaKey || e.altKey || e.key.length > 1) {
                 finalizeBuffer();
                 currentBuffer = '';
                 lastConversionLength = 0;
                 return; // Let the browser handle navigation etc.
            }

            // Handle Space and Punctuation: Finalize buffer first
            // Use a regex for common punctuation. Adjust as needed.
            if (e.key === ' ' || e.key.match(/^[.,!?;:"(){}[\]<>/\\|`~@#$%^&*+=_\-]$/)) {
                finalizeBuffer();
                currentBuffer = '';
                lastConversionLength = 0;
                // Let the space or punctuation character be inserted normally by the browser
                return;
            }

            // Handle letters, numbers, apostrophe
            if (e.key.match(/^[a-zA-Z0-9']$/)) {
                e.preventDefault(); // Prevent default insertion, we'll handle it
                const typedChar = e.key; // Store the character typed
                currentBuffer += typedChar; // Append to buffer *before* inserting
                insertText(typedChar); // Insert the typed Latin character for immediate feedback
                processBuffer(); // Attempt conversion immediately after insertion
            } else {
                 // Any other unexpected key? Finalize and clear.
                 finalizeBuffer();
                 currentBuffer = '';
                 lastConversionLength = 0;
            }
        });

        // Focus textarea on page load
        inputText.focus();

    </script>
</body>
</html>
