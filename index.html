    <!-- ... existing HTML ... -->
    <script>
        const inputText = document.getElementById('inputText');
        const keyboardContainer = document.querySelector('.keyboard');
        let currentBuffer = ''; // Stores the sequence of typed Latin letters
        let lastConversionLength = 0; // Track length of last Latin sequence converted

        // --- Phonetic Mapping (Keep the existing amharicMap) ---
        const amharicMap = {
            // Consonant + Vowel combinations (Sorted by Latin length desc)
            'hhwa': 'ሗ', 'hhua': 'ሗ',
            'shwa': 'ሿ', 'shua': 'ሿ',
            'chwa': 'ቿ', 'chua': 'ቿ',
            'nywa': 'ኟ', 'nyua': 'ኟ',
            'zhwa': 'ዧ', 'zhua': 'ዧ',
            'cchwa': 'ጯ', 'cchua': 'ጯ',
            'gnwa': 'ጟ', 'gnua': 'ጟ',
            'hho': 'ሖ', // Using one mapping for simplicity, can be adjusted
            'hhe': 'ሕ',
            'hhee': 'ሔ',
            'hhaa': 'ሓ',
            'hhi': 'ሒ',
            'hhu': 'ሑ',
            'ssa': 'ሣ', 'ssu': 'ሡ', 'ssi': 'ሢ', 'ssee': 'ሤ', 'sse': 'ሥ', 'sso': 'ሦ', 'sswa': 'ሧ', 'ssua': 'ሧ',
            'kxa': 'ኸ', 'kxu': 'ኹ', 'kxi': 'ኺ', 'kxaa': 'ኻ', 'kxee': 'ኼ', 'kxe': 'ኽ', 'kxo': 'ኾ', 'kxwa': 'ዃ', 'kxua': 'ዃ',
            'tta': 'ጠ', 'ttu': 'ጡ', 'tti': 'ጢ', 'ttaa': 'ጣ', 'ttee': 'ጤ', 'tte': 'ጥ', 'tto': 'ጦ', 'ttwa': 'ጧ', 'ttua': 'ጧ',
            'ccha': 'ጨ', 'cchu': 'ጩ', 'cchi': 'ጪ', 'cchaa': 'ጫ', 'cchee': 'ጬ', 'cche': 'ጭ', 'ccho': 'ጮ', // 'cchwa' handled above
            'tsa': 'ፀ', 'tsu': 'ፁ', 'tsi': 'ፂ', 'tsaa': 'ፃ', 'tsee': 'ፄ', 'tse': 'ፅ', 'tso': 'ፆ', 'tswa': 'ፇ', 'tsua': 'ፇ',
            'gna': 'ኛ', 'gnu': 'ኙ', 'gni': 'ኚ', 'gnaa': 'ኛ', 'gnee': 'ኜ', 'gne': 'ኝ', 'gno': 'ኞ', // 'gnwa' handled above
            'nya': 'ኘ', 'nyu': 'ኙ', 'nyi': 'ኚ', 'nyaa': 'ኛ', 'nyee': 'ኜ', 'nye': 'ኝ', 'nyo': 'ኞ', // 'nywa' handled above
            'sha': 'ሸ', 'shu': 'ሹ', 'shi': 'ሺ', 'shaa': 'ሻ', 'shee': 'ሼ', 'she': 'ሽ', 'sho': 'ሾ', // 'shwa' handled above
            'cha': 'ቸ', 'chu': 'ቹ', 'chi': 'ቺ', 'chaa': 'ቻ', 'chee': 'ቼ', 'che': 'ች', 'cho': 'ቾ', // 'chwa' handled above
            'zha': 'ዠ', 'zhu': 'ዡ', 'zhi': 'ዢ', 'zhaa': 'ዣ', 'zhee': 'ዤ', 'zhe': 'ዥ', 'zho': 'ዦ', // 'zhwa' handled above
            'qwa': 'ቋ', 'qua': 'ቋ', 'qoa': 'ቈ',
            'bwa': 'ቧ', 'bua': 'ቧ',
            'twa': 'ቷ', 'tua': 'ቷ',
            'nwa': 'ኗ', 'nua': 'ኗ',
            'kwa': 'ኳ', 'kua': 'ኳ',
            'zwa': 'ዟ', 'zua': 'ዟ',
            'dwa': 'ዷ', 'dua': 'ዷ',
            'jwa': 'ጇ', 'jua': 'ጇ',
            'gwa': 'ጓ', 'gua': 'ጓ',
            'pwa': 'ጷ', 'pua': 'ጷ', // For ጰ series
            'fwa': 'ፏ', 'fua': 'ፏ',
            'ppwa': 'ፗ', 'ppua': 'ፗ', // Use 'pp' for ፐ series 'pwa'

            // Standard Consonant + Vowel
            'ha': 'ሀ', 'hu': 'ሁ', 'hi': 'ሂ', 'haa': 'ሃ', 'hee': 'ሄ', 'he': 'ህ', 'ho': 'ሆ',
            'le': 'ለ', 'lu': 'ሉ', 'li': 'ሊ', 'laa': 'ላ', 'lee': 'ሌ', 'l': 'ል', 'lo': 'ሎ', 'lua': 'ሏ',
            'me': 'መ', 'mu': 'ሙ', 'mi': 'ሚ', 'ma': 'ማ', 'maa': 'ማ', 'mee': 'ሜ', 'm': 'ም', 'mo': 'ሞ', 'mua': 'ሟ',
            're': 'ረ', 'ru': 'ሩ', 'ri': 'ሪ', 'raa': 'ራ', 'ree': 'ሬ', 'r': 'ር', 'ro': 'ሮ', 'rwa': 'ሯ', 'rua': 'ሯ',
            'se': 'ሰ', 'su': 'ሱ', 'si': 'ሲ', 'saa': 'ሳ', 'see': 'ሴ', 's': 'ስ', 'so': 'ሶ', 'swa': 'ሷ', 'sua': 'ሷ',
            'qe': 'ቀ', 'qu': 'ቁ', 'qi': 'ቂ', 'qaa': 'ቃ', 'qee': 'ቄ', 'q': 'ቅ', 'qo': 'ቆ',
            'be': 'በ', 'bu': 'ቡ', 'bi': 'ቢ', 'baa': 'ባ', 'bee': 'ቤ', 'b': 'ብ', 'bo': 'ቦ',
            'te': 'ተ', 'tu': 'ቱ', 'ti': 'ቲ', 'taa': 'ታ', 'tee': 'ቴ', 't': 'ት', 'to': 'ቶ',
            'ne': 'ነ', 'nu': 'ኑ', 'ni': 'ኒ', 'naa': 'ና', 'nee': 'ኔ', 'n': 'ን', 'no': 'ኖ',
            'ka': 'ከ', 'ku': 'ኩ', 'ki': 'ኪ', 'kaa': 'ካ', 'kee': 'ኬ', 'k': 'ክ', 'ko': 'ኮ',
            'we': 'ወ', 'wu': 'ዉ', 'wi': 'ዊ', 'waa': 'ዋ', 'wee': 'ዌ', 'w': 'ው', 'wo': 'ዎ',
            'ze': 'ዘ', 'zu': 'ዙ', 'zi': 'ዚ', 'zaa': 'ዛ', 'zee': 'ዜ', 'z': 'ዝ', 'zo': 'ዞ',
            'ye': 'የ', 'yu': 'ዩ', 'yi': 'ዪ', 'yaa': 'ያ', 'yee': 'ዬ', 'y': 'ይ', 'yo': 'ዮ',
            'de': 'ደ', 'du': 'ዱ', 'di': 'ዲ', 'daa': 'ዳ', 'dee': 'ዴ', 'd': 'ድ', 'do': 'ዶ',
            'je': 'ጀ', 'ju': 'ጁ', 'ji': 'ጂ', 'jaa': 'ጃ', 'jee': 'ጄ', 'j': 'ጅ', 'jo': 'ጆ',
            'ge': 'ገ', 'gu': 'ጉ', 'gi': 'ጊ', 'gaa': 'ጋ', 'gee': 'ጌ', 'g': 'ግ', 'go': 'ጎ',
            'ppe': 'ጰ', 'ppu': 'ጱ', 'ppi': 'ጲ', 'ppaa': 'ጳ', 'ppee': 'ጴ', 'pp': 'ጵ', 'ppo': 'ጶ', // Use 'pp' for ጰ series
            'fe': 'ፈ', 'fu': 'ፉ', 'fi': 'ፊ', 'faa': 'ፋ', 'fee': 'ፌ', 'f': 'ፍ', 'fo': 'ፎ',
            'pe': 'ፐ', 'pu': 'ፑ', 'pi': 'ፒ', 'paa': 'ፓ', 'pee': 'ፔ', 'p': 'ፕ', 'po': 'ፖ', // Use 'p' for ፐ series

             // Standalone Vowels (using apostrophe prefix)
            '\'a': 'አ', '\'u': 'ኡ', '\'i': 'ኢ', '\'aa': 'ኣ', '\'ee': 'ኤ', '\'e': 'እ', '\'o': 'ኦ', '\'ea': 'ኧ',

            // Numbers
            '1': '፩', '2': '፪', '3': '፫', '4': '፬', '5': '፭', '6': '፮', '7': '፯', '8': '፰', '9': '፱', '10': '፲',
            '20': '፳', '30': '፴', '40': '፵', '50': '፶', '60': '፷', '70': '፸', '80': '፹', '90': '፺', '100': '፻'
        };

        // Map base consonant sounds to their 6th form for finalization
        const sixthFormMap = {
             'h': 'ህ', 'l': 'ል', 'hh': 'ሕ', 'm': 'ም', 'ss': 'ሥ', 'r': 'ር', 's': 'ስ',
             'sh': 'ሽ', 'q': 'ቅ', 'b': 'ብ', 't': 'ት', 'ch': 'ች', 'h': 'ኅ', // Note: 'h' is ambiguous, might need 'xh' or similar for ኅ
             'n': 'ን', 'ny': 'ኝ', 'a': 'እ', // Using 'a' for 'እ' 6th form
             'k': 'ክ', 'kx': 'ኽ', 'w': 'ው', '´': 'ዕ', // Using '´' (backtick) for 'ዕ' 6th form
             'z': 'ዝ', 'zh': 'ዥ', 'y': 'ይ', 'd': 'ድ', 'j': 'ጅ', 'g': 'ግ',
             'tt': 'ጥ', 'cch': 'ጭ', 'pp': 'ጵ', 'ts': 'ፅ', 'f': 'ፍ', 'p': 'ፕ',
             // Add single vowels if they should finalize to a specific form on space
             'e': 'እ', 'i': 'ኢ', 'o': 'ኦ', 'u': 'ኡ' // Example: finalize 'e' to 'እ'
        };

        // --- Helper Functions ---

        function insertText(textToInsert, replaceLength = 0) {
            const start = inputText.selectionStart;
            const end = inputText.selectionEnd;
            const text = inputText.value;
            const positionBeforeInsertion = start - replaceLength; // Calculate position before potential replacement

            inputText.value = text.substring(0, positionBeforeInsertion) + textToInsert + text.substring(end);
            // Place cursor right after the inserted text
            inputText.selectionStart = inputText.selectionEnd = positionBeforeInsertion + textToInsert.length;
            inputText.focus();
            // Trigger input event for frameworks or other listeners
            inputText.dispatchEvent(new Event('input', { bubbles: true }));
        }


        function handleBackspace() {
            const start = inputText.selectionStart;
            const end = inputText.selectionEnd;

            if (start === end && start > 0) {
                // Check if we are deleting a character that was part of the last conversion
                const deletedChar = inputText.value.substring(start - 1, start);
                // Simple approach: If backspacing right after a conversion, clear the buffer.
                // A more complex approach would involve trying to "undo" the conversion.
                if (lastConversionLength > 0 && start === inputText.selectionEnd) {
                     // Maybe clear buffer if backspacing immediately after conversion?
                     // currentBuffer = ''; // This might be too aggressive
                }
                 lastConversionLength = 0; // Reset conversion tracking on backspace

                // Perform standard backspace
                inputText.value = inputText.value.substring(0, start - 1) + inputText.value.substring(end);
                inputText.selectionStart = inputText.selectionEnd = start - 1;

            } else if (start !== end) {
                // Delete selection
                inputText.value = inputText.value.substring(0, start) + inputText.value.substring(end);
                inputText.selectionStart = inputText.selectionEnd = start;
                lastConversionLength = 0; // Reset conversion tracking
            }
            currentBuffer = ''; // Clear buffer on any backspace for simplicity
            inputText.focus();
            inputText.dispatchEvent(new Event('input', { bubbles: true }));
        }

        function handleEnter() {
             finalizeBuffer(); // Finalize before newline
             insertText('\n');
             currentBuffer = ''; // Clear buffer after enter
             lastConversionLength = 0;
        }

        // Tries to convert the current buffer to Amharic
        function processBuffer() {
            if (!currentBuffer) {
                lastConversionLength = 0;
                return false;
            }

            let foundMatch = false;
            const sortedKeys = Object.keys(amharicMap).sort((a, b) => b.length - a.length);

            for (const key of sortedKeys) {
                // Check if the *end* of the buffer matches a key
                if (currentBuffer.endsWith(key)) {
                    const amharicChar = amharicMap[key];
                    // Replace the matched Latin part (key) with the Amharic char
                    insertText(amharicChar, key.length); // Replace 'key.length' characters
                    // Remove the matched part from the buffer
                    currentBuffer = currentBuffer.slice(0, -key.length);
                    lastConversionLength = key.length; // Track length of converted sequence
                    foundMatch = true;
                    // Check buffer again in case the remaining part forms another character
                    // (e.g., typing 'selam' -> process 'la' -> 'ላ', buffer becomes 'se', process 'se' -> 'ሰ')
                    return processBuffer(); // Recursive call to process remaining buffer
                }
            }

             // If no direct match, keep the buffer as is for now
             lastConversionLength = 0; // No conversion happened in this pass
             return false;
        }

        // Finalizes the buffer, typically converting to 6th form if applicable
        function finalizeBuffer() {
            if (!currentBuffer) return;

            let amharicChar = null;
            let keyLength = 0;

            // Check if the entire buffer matches a 6th form key
            const sortedSixthKeys = Object.keys(sixthFormMap).sort((a, b) => b.length - a.length);
            for(const key of sortedSixthKeys) {
                if (currentBuffer === key) {
                    amharicChar = sixthFormMap[key];
                    keyLength = key.length;
                    break;
                }
            }

            if (amharicChar) {
                insertText(amharicChar, keyLength); // Replace buffer with 6th form
            }
            // If no 6th form match, the buffer remains as typed Latin letters (or was already processed)
            currentBuffer = ''; // Clear buffer after finalization attempt
            lastConversionLength = 0;
        }


        // --- Event Listeners ---

        keyboardContainer.addEventListener('click', (e) => {
            const target = e.target.closest('.keyboard-key');
            if (!target) return;

            const char = target.getAttribute('data-char');
            const action = target.getAttribute('data-action');

            finalizeBuffer(); // Finalize any pending buffer before button press

            if (char) {
                insertText(char); // Directly insert clicked character
            } else if (action === 'backspace') {
                handleBackspace();
            } else if (action === 'enter') {
                handleEnter();
            }
             currentBuffer = ''; // Clear buffer after virtual key action
             lastConversionLength = 0;
        });

        inputText.addEventListener('keydown', (e) => {
            // Let Backspace and Enter be handled by their dedicated functions
            if (e.key === 'Backspace') {
                handleBackspace();
                e.preventDefault(); // Prevent default backspace since we handle it
                return;
            }
            if (e.key === 'Enter') {
                handleEnter();
                e.preventDefault(); // Prevent default Enter since we handle it
                return;
            }

            // Ignore modifiers, arrows, etc.
            if (e.ctrlKey || e.metaKey || e.altKey || e.key.length > 1) {
                 finalizeBuffer(); // Finalize buffer on navigation/modifier keys
                 currentBuffer = '';
                 lastConversionLength = 0;
                 return; // Let the browser handle navigation etc.
            }

            // Handle Space and Punctuation: Finalize buffer first
            if (e.key === ' ' || e.key.match(/[^a-zA-Z0-9']/)) { // Added apostrophe as potentially valid input
                finalizeBuffer();
                currentBuffer = '';
                lastConversionLength = 0;
                // Let the space or punctuation character be inserted normally by the browser
                return;
            }

            // Handle letters, numbers, apostrophe
            if (e.key.match(/^[a-zA-Z0-9']$/)) {
                e.preventDefault(); // Prevent default insertion, we'll handle it
                currentBuffer += e.key; // Append to buffer
                insertText(e.key); // Insert the typed Latin character for immediate feedback
                processBuffer(); // Attempt conversion
            } else {
                 // Any other unexpected key? Finalize and clear.
                 finalizeBuffer();
                 currentBuffer = '';
                 lastConversionLength = 0;
            }
        });

        // Focus textarea on page load
        inputText.focus();

    </script>
</body>
</html>
